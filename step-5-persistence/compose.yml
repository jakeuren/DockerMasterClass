# Microservices Demo Stack with PostgreSQL Persistence
# This demonstrates:
# - Data persistence with PostgreSQL
# - Volume mounting for database durability
# - Database health checks and initialization
# - Environment-based configuration

services:
  # PostgreSQL Database - Shared by all services
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: microservices
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - microservices-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d microservices"]
      interval: 5s
      timeout: 5s
      retries: 5

  # API Gateway - Single entry point for all requests
  api-gateway:
    build: ./api-gateway
    ports:
      - "9000:5000"
    depends_on:
      postgres:
        condition: service_healthy
      users-service:
        condition: service_started
      orders-service:
        condition: service_started
      inventory-service:
        condition: service_started
    environment:
      - USERS_SERVICE_URL=http://users-service:5001
      - ORDERS_SERVICE_URL=http://orders-service:5002
      - INVENTORY_SERVICE_URL=http://inventory-service:5003
    networks:
      - microservices-net

  # Users Service - Manages user data with PostgreSQL
  users-service:
    build: ./users-service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=Host=postgres;Database=microservices;Username=postgres;Password=postgres
    networks:
      - microservices-net

  # Orders Service - Manages orders with PostgreSQL
  orders-service:
    build: ./orders-service
    depends_on:
      postgres:
        condition: service_healthy
      users-service:
        condition: service_started
      inventory-service:
        condition: service_started
    environment:
      - DATABASE_URL=Host=postgres;Database=microservices;Username=postgres;Password=postgres
      - USERS_SERVICE_URL=http://users-service:5001
      - INVENTORY_SERVICE_URL=http://inventory-service:5003
    networks:
      - microservices-net

  # Inventory Service - Manages product inventory with PostgreSQL
  inventory-service:
    build: ./inventory-service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=Host=postgres;Database=microservices;Username=postgres;Password=postgres
    networks:
      - microservices-net

  # React Frontend
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - microservices-net

networks:
  microservices-net:
    driver: bridge

volumes:
  postgres-data:
    # Named volume for database persistence
    # Data survives container restarts and removals
